---
title: "å…³äºChatRoom"
date: 2021/02/10
publish: true
tags:
  - React
  - node.js
  - å‰ç«¯
  - é¡¹ç›®
  - Typescript
slug: about-chatroom
description: æœ€è¿‘è¿™å‡ å¤©åœ¨å­¦ä¹ Reactï¼Œæ‰€ä»¥è¿™ä¸ªé¡¹ç›®ä¸»è¦ç›®çš„æ˜¯ç»™æˆ‘ç†Ÿæ‚‰Reactï¼Œæˆ‘ä¸ªäººæ˜¯å–œæ¬¢è¾¹å­¦ä¹ ä¸€æ ·æ–°ä¸œè¥¿è¾¹åŠ¨æ‰‹ï¼Œåªæœ‰è¾“å‡ºæ‰ä¼šè®©æˆ‘è®°å¿†æ›´æ·±åˆ»ï¼Œå…¶æ¬¡ä¹Ÿä¼šè¸©åˆ°ä¸€äº›å…‰çœ‹æ˜¯ä¸ä¼šç¢°åˆ°çš„å‘ï¼ŒåŠ ä¸Šä¹‹å‰å­¦ä¹ node.jså¥½åƒä¹Ÿæ²¡æœ‰åšä»€ä¹ˆï¼Œäºæ˜¯å°±æƒ³åˆ°äº†ç»“åˆåœ¨ä¸€å—åšä¸€ä¸ªèŠå¤©å®¤ã€‚
---
# å­¦ä¹ æ–°ä¸œè¥¿ğŸ‘‹
æœ€è¿‘è¿™å‡ å¤©åœ¨å­¦ä¹ Reactï¼Œæ‰€ä»¥è¿™ä¸ªé¡¹ç›®ä¸»è¦ç›®çš„æ˜¯ç»™æˆ‘ç†Ÿæ‚‰Reactï¼Œæˆ‘ä¸ªäººæ˜¯å–œæ¬¢è¾¹å­¦ä¹ ä¸€æ ·æ–°ä¸œè¥¿è¾¹åŠ¨æ‰‹ï¼Œåªæœ‰è¾“å‡ºæ‰ä¼šè®©æˆ‘è®°å¿†æ›´æ·±åˆ»ï¼Œå…¶æ¬¡ä¹Ÿä¼šè¸©åˆ°ä¸€äº›å…‰çœ‹æ˜¯ä¸ä¼šç¢°åˆ°çš„å‘ï¼ŒåŠ ä¸Šä¹‹å‰å­¦ä¹ node.jså¥½åƒä¹Ÿæ²¡æœ‰åšä»€ä¹ˆï¼Œäºæ˜¯å°±æƒ³åˆ°äº†ç»“åˆåœ¨ä¸€å—åšä¸€ä¸ªèŠå¤©å®¤ã€‚âœŒ  


å› ä¸ºæ˜¯ç¬¬ä¸€æ¬¡åšReactï¼Œå¦‚æœè§‰å¾—æœ‰ä»€ä¹ˆéœ€è¦ä¿®æ”¹çš„æ¬¢è¿æå‡º[Issuse](https://github.com/Magren0321/ChatRoom/issues)ï¼Œä¹Ÿæ¬¢è¿ä½ çš„starâ­

é¡¹ç›®åœ°å€ï¼š[ChatRoom](https://github.com/Magren0321/ChatRoom)

é¡¹ç›®æˆªå›¾ï¼š
![](/postImg/about-chatroom/3.png)  
![](/postImg/about-chatroom/2.png)  
![](/postImg/about-chatroom/1.png)  

# åç«¯
åç«¯åŸºäºNode.js + Express + Socket.io + MongoDB  
Node.jsæ“ä½œMongoDBä»¥åŠç”¨expresså†™æ¥å£ä¹‹å‰éƒ½æœ‰åœ¨åšå®¢ä¸­å¤§è‡´çš„æ€»ç»“è¿‡ï¼š  
[Node.js+express](/posts/node-express/)  
[Node.Jsæ“ä½œMongoDB](/posts/node-mongodb/)  
è¿™æ¬¡ç”¨çš„æ–°ä¸œè¥¿å°±æ˜¯Socket.ioã€‚

## å‰äººçš„å·¥ä½œğŸ‘‡
> Socket.IO is a library that enables real-time, bidirectional and event-based communication between the browser and the server

å³æ˜¯è¯´Socket.ioå¯ä»¥å®ç°æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯ä¹‹é—´çš„ä¸€ä¸ªå®æ—¶çš„åŒå‘é€šä¿¡ã€‚  
åœ¨è¿æ¥Socket.ioçš„ä¹‹å‰è¿˜å¾—å…ˆçŸ¥é“**WebSocket**ï¼Œåœ¨WebSocketé—®ä¸–ä¹‹å‰ï¼Œåœ¨åˆ›å»ºæ‹¥æœ‰åŒå‘é€šä¿¡æœºåˆ¶çš„ web åº”ç”¨ç¨‹åºæ—¶ï¼Œå°±åªèƒ½åˆ©ç”¨ HTTP è½®è¯¢çš„æ–¹å¼ï¼Œç”±æ­¤äº§ç”Ÿäº† â€œçŸ­è½®è¯¢â€ å’Œ â€œé•¿è½®è¯¢â€ã€‚

> çŸ­è½®è¯¢é€šè¿‡å®¢æˆ·ç«¯å®šæœŸè½®è¯¢æ¥è¯¢é—®æœåŠ¡ç«¯æ˜¯å¦æœ‰æ–°çš„ä¿¡æ¯äº§ç”Ÿï¼Œç¼ºç‚¹ä¹Ÿæ˜¯æ˜¾è€Œæ˜“è§ï¼Œè½®è¯¢é—´éš”å¤§äº†åˆ™ä¿¡æ¯ä¸å¤Ÿå®æ—¶ï¼Œè½®è¯¢é—´éš”è¿‡å°åˆä¼šæ¶ˆè€—è¿‡å¤šçš„æµé‡ï¼Œå¢åŠ æœåŠ¡å™¨çš„è´Ÿæ‹…ã€‚  
>é•¿è½®è¯¢æ˜¯å¯¹çŸ­è½®è¯¢çš„ä¼˜åŒ–ï¼Œéœ€è¦æœåŠ¡ç«¯åšç›¸åº”çš„ä¿®æ”¹æ¥æ”¯æŒã€‚ä½†æ˜¯æ¯æ¬¡è¯·æ±‚è¿˜æ˜¯éƒ½è¦å¸¦ä¸ŠHTTPè¯·æ±‚å¤´éƒ¨ï¼Œè€Œä¸”åœ¨é•¿è½®è¯¢çš„è¿æ¥ç»“æŸä¹‹åï¼ŒæœåŠ¡å™¨ç«¯ç§¯ç´¯çš„æ–°æ¶ˆæ¯è¦ç­‰åˆ°ä¸‹æ¬¡å®¢æˆ·ç«¯è¿æ¥æ—¶æ‰èƒ½ä¼ é€’ã€‚

Websocketåè®®å°±æ˜¯ä¸ºäº†è§£å†³é•¿è½®è¯¢çš„ç—›ç‚¹è€Œè¯ç”Ÿçš„ï¼Œå…¶åŸºäºTCPåè®®ï¼Œæ˜¯ä¸€ç§åŒå…¨å·¥é€šä¿¡æŠ€æœ¯ã€å¤ç”¨HTTPæ¡æ‰‹é€šé“ã€‚å®ƒä¸HTTPåè®®çš„å”¯ä¸€å…³ç³»å°±æ˜¯å®ƒçš„æ¡æ‰‹è¯·æ±‚å¯ä»¥ä½œä¸ºä¸€ä¸ª**Upgrade request**ç»ç”±HTTPæœåŠ¡å™¨è§£æï¼Œä¸”ä¸HTTPä½¿ç”¨ä¸€æ ·çš„ç«¯å£ã€‚

æ¥ç€æ˜¯**Socket.io**ï¼ŒSocket.ioåº•å±‚åŸºäº**engine.io**ï¼Œå°è£…äº†WebSocketï¼Œå…¶å±è”½äº†åº•å±‚ç»†èŠ‚ï¼Œè®©é¡¶å±‚è°ƒç”¨éå¸¸ç®€å•ã€‚åŒæ—¶å®ƒè¿˜æ”¯æŒè®¸å¤šç§è½®è¯¢æœºåˆ¶ä»¥åŠå…¶ä»–é€šä¿¡æ–¹å¼ï¼Œå½“ç¯å¢ƒä¸æ”¯æŒWebSocketçš„æ—¶å€™å®ƒèƒ½è‡ªåŠ¨é€‰æ‹©æœ€ä½³çš„æ–¹å¼æ¥å®ç°ç½‘ç»œçš„å®æ—¶é€šä¿¡ã€‚

## ä½¿ç”¨
å¼•å…¥ioè®¾ç½®ç«¯å£åç›‘å¬connectäº‹ä»¶ï¼š
```js
const server = require('http').Server(app);  
const io = require('socket.io')(server);  

server.listen(3001); //ç«¯å£è®¾ç½®3001

io.on(('connection', socket=>{
    
    â€¦â€¦â€¦â€¦â€¦â€¦

})
```
æ¥ç€é€šè¿‡æœ€é‡è¦çš„ä¸¤ä¸ªapiï¼Œ**emit**å’Œ**on**æ¥å‘é€ä»¥åŠç›‘å¬äº‹ä»¶
+ socket.emit(eventName,[ ...args])ï¼šå‘å°„ï¼ˆè§¦å‘ï¼‰ä¸€ä¸ªäº‹ä»¶
+ socket.on(eventName, callback)ï¼šç›‘å¬ä¸€ä¸ª emit å‘å°„çš„äº‹ä»¶
```js
//ç›‘å¬xxxäº‹ä»¶ï¼Œè¾“å‡ºä¼ è¿›æ¥çš„dataå¯¹è±¡
socket.on('xxx',data=>{
  console.log(data);
})
//å‘é€xxxäº‹ä»¶ï¼Œä¼ å‡ºå»ä¸€ä¸ªå¯¹è±¡ï¼Œé‡Œé¢æœ‰nameå±æ€§
socket.emit('xxx',{name:'magren'})
```
å¦å¤–ç”¨åˆ°çš„æ–¹æ³•
+ socket.join(id)ï¼šåŠ å…¥åˆ°ä¸€ä¸ªroomä¸ºidçš„æˆ¿é—´ä¸­
+ socket.broadcast.to(id).emit( )ï¼šå¹¿æ’­ç»™roomä¸ºidçš„é™¤äº†â€˜æˆ‘â€™ä»¥å¤–çš„æ‰€æœ‰äºº
+ io.sockets.in(id).emit( )ï¼šå¹¿æ’­ç»™roomä¸ºidçš„æ‰€æœ‰äºº

# å‰ç«¯
å‰ç«¯åŸºäºReact + Redux + Typescript + Antd  

å‘åå°å‘é€æ¶ˆæ¯ä»¥åŠç›‘å¬å¾ˆç®€å•ï¼Œåªéœ€è¦å¼•å…¥**socket.io-client**ï¼Œæ¥ç€ä½¿ç”¨emitå‘é€å’Œonç›‘å¬äº‹ä»¶å³å¯ã€‚

```js
const socket = require('socket.io-client')('ws://localhost:3001',{transports: ['websocket']})

//ç›‘å¬ä¿¡æ¯
socket.on('chat_message',(data: mesItem)=>{
  this.setState({
    message:[data,...this.state.message]
  });
})
//å‘é€åŠ å…¥ç¾¤ç»„
socket.emit('join', {
  roomId:this.props.match.params.roomId,
  userName:this.props.state.name,
  userId:this.props.state.id
})
//å‘é€ä¿¡æ¯
socket.emit('mes',{
  roomId:this.props.match.params.roomId,
  userName:this.props.state.name,
  userId:this.props.state.id,
  mes:this.state.msg
})
```
## å…³äºRedux
reduxè·Ÿvuexçš„ç†å¿µç»™æˆ‘çš„æ„Ÿè§‰æ˜¯ä¸€æ ·çš„ï¼ŒåŒæ ·éƒ½æ˜¯ä¸€ä¸ªçŠ¶æ€ç®¡ç†åº“ï¼Œå¹¶ä¸”éƒ½æ˜¯ä¿å­˜åœ¨å†…å­˜å½“ä¸­ï¼ˆåˆ·æ–°å°±ä¼šé‡ç½®ï¼‰ï¼Œå®šä¹‰å…¨å±€stateï¼Œè§¦å‘åä¿®æ”¹stateã€‚ä¸åŒçš„åœ°æ–¹ä¹Ÿè¿˜æ˜¯æœ‰çš„ï¼ŒVuexçš„æ•°æ®æ˜¯å¯å˜å¯ç›´æ¥ä¿®æ”¹ï¼ŒReduxä¸å¯å˜å¹¶ä¸”æ˜¯ç›´æ¥ç”¨æ–°çš„stateæ›¿æ¢æ‰æ—§çš„stateã€‚  

è¿™ä¸ªé¡¹ç›®ç”¨äº† **[react-redux](https://github.com/reduxjs/react-redux)** å’Œ **[redux-thunk](https://github.com/reduxjs/redux-thunk)** ä¸¤ä¸ªåº“ã€‚  

ä½¿ç”¨äº†react-reduxåæµç¨‹å¤§å¤§ç¼©çŸ­ï¼Œstoreçš„ä¸‰å¤§åŠŸèƒ½ï¼šdispatchï¼Œsubscribeï¼ŒgetStateéƒ½è®©å®ƒæ¥å¸®æˆ‘ä»¬å®ç°äº†ï¼ŒåŒæ—¶å®ƒæä¾›äº†Providerå’ŒConnectï¼Œå‰è€…æ˜¯ä¸€ä¸ªç»„ä»¶ï¼Œåè€…æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚  
å¤§è‡´çš„æµç¨‹å°±æ˜¯Providerç»„ä»¶æ¥å—reduxçš„storeä½œä¸ºpropsï¼Œç„¶åé€šè¿‡contextå¾€ä¸‹ä¼ ï¼Œconnectå‡½æ•°æ”¶åˆ°Providerä¼ å‡ºçš„storeï¼Œå¹¶å°†stateå’ŒactionCreatorä»¥propsä¼ å…¥ç»„ä»¶ï¼Œç»„ä»¶å°±å¯ä»¥é€šè¿‡è°ƒç”¨propsé‡Œçš„actionè§¦å‘reducerå‡½æ•°è¿”å›æ–°çš„stateï¼Œconnectç›‘å¬åˆ°å˜åŒ–åè°ƒç”¨setStateæ›´æ–°ç»„ä»¶å¹¶å°†æ–°çš„stateä¼ å…¥ã€‚  

**redux-thunk**çš„ä½œç”¨ï¼šå¯ä»¥è®© store.dispatch å˜æˆå¯ä»¥æ¥æ”¶ä¸€ä¸ªå‡½æ•°/ä¸€ä¸ªå¯¹è±¡çš„ä¸­é—´ä»¶ã€‚
> è®©åŸæœ¬åªèƒ½æ¥å—å¯¹è±¡çš„ store.dispatch å˜æˆå¯ä»¥æ¥æ”¶å¯¹è±¡/æ–¹æ³•ï¼Œå¹¶ä¸”å¦‚æœæ¥æ”¶äº†ä¸€ä¸ªæ–¹æ³•åè‡ªåŠ¨æ‰§è¡Œè¯¥æ–¹æ³•ï¼Œè€Œä¸è§¦å‘ redux çš„ store æ›´æ–°ã€‚

# æœ€åğŸ’»
æ„Ÿè°¢Googleã€baiduç­‰æœç´¢å¼•æ“å’ŒGoogleç¿»è¯‘ğŸ˜µ  
ä»¥åŠ[bailicangdu](https://github.com/bailicangdu)å¤§ä½¬çš„[react-pxq](https://github.com/bailicangdu/react-pxq)é¡¹ç›®çš„å‚è€ƒä»¥åŠæ€»ç»“ğŸ˜˜
